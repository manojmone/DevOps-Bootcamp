
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Installing Jenkins and Setting up a Pipeline</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Setting up Developer PC and accessing Git" href="../devgit/devgit.html" />

<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

<link href="http://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  </head><body>

  <div id="navbar" class="navbar-inverse navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/NutanixWorkshops.svg"></span>
           </a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html"> <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Setting up Developer PC and accessing Git</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../devgit/devgit.html">Setting up Developer PC and accessing Git</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../devgit/devgit.html#lab-agenda">Lab Agenda</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devgit/devgit.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devgit/devgit.html#getting-the-developer-workstation-ready">Getting the Developer workstation ready</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devgit/devgit.html#working-with-github">Working with Github</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devgit/devgit.html#working-with-our-code-and-publishing-it-to-git">Working with our code and publishing it to Git</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Installing Jenkins and Setting up a Pipeline</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lab 2: Installing Jenkins and Setting up a Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lab-agenda">Lab Agenda</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installing-jenkins">Installing Jenkins</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-jenkins-to-build-docker-images">Working with Jenkins to build Docker Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-1-launch-jenkins">Step #1 : Launch Jenkins</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-configure-the-plugins-and-start-building-docker-images">Step #2 : Configure the plugins and start building Docker Images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-configure-docker-agent">Step #3 : Configure Docker agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-4-test-the-setup">Step #4 : Test the setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-jenkins-pipelines">Working with Jenkins Pipelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-a-new-job">Create a new job</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><p class="caption"><span class="caption-text">Setting up Developer PC and accessing Git</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../devgit/devgit.html">Setting up Developer PC and accessing Git</a></li>
</ul>
<p class="caption"><span class="caption-text">Installing Jenkins and Setting up a Pipeline</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lab 2: Installing Jenkins and Setting up a Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lab-agenda">Lab Agenda</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installing-jenkins">Installing Jenkins</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-jenkins-to-build-docker-images">Working with Jenkins to build Docker Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-1-launch-jenkins">Step #1 : Launch Jenkins</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-configure-the-plugins-and-start-building-docker-images">Step #2 : Configure the plugins and start building Docker Images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-configure-docker-agent">Step #3 : Configure Docker agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-4-test-the-setup">Step #4 : Test the setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-jenkins-pipelines">Working with Jenkins Pipelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-a-new-job">Create a new job</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="lab-2-installing-jenkins-and-setting-up-a-pipeline">
<span id="devjenkins"></span><h1>Lab 2: Installing Jenkins and Setting up a Pipeline<a class="headerlink" href="#lab-2-installing-jenkins-and-setting-up-a-pipeline" title="Permalink to this headline">¶</a></h1>
<p>Welcome to the second lab of the DevOps Bootcamp!</p>
<p>In this lab you will install Jenkins and configure a pipeline.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Estimated time to complete this lab is 45 minutes</p>
</div>
<div class="section" id="lab-agenda">
<h2>Lab Agenda<a class="headerlink" href="#lab-agenda" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Install Jenkins</li>
<li>Configure a Pipeline</li>
</ul>
</div>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>You will have completed the Lab 1 of this bootcamp</li>
<li>We will be using the Ubuntu container created in the first lab for the developer workstation</li>
</ul>
</div>
<div class="section" id="installing-jenkins">
<h2>Installing Jenkins<a class="headerlink" href="#installing-jenkins" title="Permalink to this headline">¶</a></h2>
<p>We will again use Docker to create a new Jenkins instamce. Before we get started, you’ll need to ensure that you have installed Docker on your machine.</p>
<p>After installing Docker, download the latest stable Jenkins image by running:</p>
<p>docker image pull jenkins/jenkins:lts</p>
<dl class="docutils">
<dt>The main benefit of using Docker containers for hosting Jenkins is that you will be able to persist the state of your Jenkins server using Docker volumes. How does that help?</dt>
<dd><ul class="first last simple">
<li>You will retain all your projects and configurations even after restarting your computer (local machine)</li>
<li>You don’t need to run the whole Jenkins setup again</li>
<li>You may remove your container instance and still able to recover the state of your Jenkins server</li>
</ul>
</dd>
</dl>
<p>You can create a volume by running the command below:</p>
<p>docker volume create [YOUR VOLUME]</p>
<p>For example, if you wish to name your docker volume name as jenkinsvol:</p>
<p>docker volume create jenkinsvol</p>
<p>Run the container by attaching the volume and assigning the targeted port. In this example, we’ll also run it in detached mode. Here is the command to run your Docker container:</p>
<dl class="docutils">
<dt>docker container run -d </dt>
<dd><p class="first">-p [YOUR PORT]:8080 -v [YOUR VOLUME]:/var/jenkins_home –name jenkins-local jenkins/jenkins:lts</p>
<p>Here is what each argument means:</p>
<p class="last">-d: detached mode
-v: attach volume
-p: assign port target
—name: name of the container</p>
</dd>
</dl>
<p>For example, the command below will create a new container named jenkins-local that uses docker volume named jenkinsvol.</p>
<dl class="docutils">
<dt>docker container run -d -p 8082:8080 </dt>
<dd>-v jenkinsvol:/var/jenkins_home –name jenkins-local jenkins/jenkins:lts</dd>
</dl>
<p>If you were to run the docker ps command now, you should see two containers one would be the ubuntu container created in lab 1 and second will be the jenkins container.</p>
<p>Now that we know that our container is running, we will use the browser to access our Jenkins instance.</p>
<p>localhost:[YOUR PORT] (localhost:8082 based on my docker container run example above) You can replace 8082 to the port of your choice.</p>
<p>You will be shown a scree like the one below -</p>
<p>&lt;.. image:: path
&gt;</p>
<p>So where’s this password? As a part of the Jenkins setup, the password is kept inside the container instance. In order to do this, we need to use the CONTAINER ID (or the name) and run docker exec.</p>
<dl class="docutils">
<dt>Here is the full command to access it -</dt>
<dd>docker container exec [CONTAINER ID or NAME] sh -c “cat /var/jenkins_home/secrets/initialAdminPassword”</dd>
<dt>So to find the password for my container named jenkins-local, the command will be:</dt>
<dd>docker container exec jenkins-local sh -c “cat /var/jenkins_home/secrets/initialAdminPassword”</dd>
</dl>
<p>You will be shown an alpha-numeric code as an output, Copy the code and paste it on the webpage to unlock Jenkins.
After unlocking, click on Install suggested plugins tile on the Customize Jenkins page.</p>
<p>Wait until the installation of suggested plugins is complete and then you can proceed in creating your first admin user.
After creating the admin user, setup the Instance configuration. Since you are only using Jenkins locally, leave the URL to your localhost URL.
Click on Save and Finish to start using Jenkins.</p>
</div>
<div class="section" id="working-with-jenkins-to-build-docker-images">
<h2>Working with Jenkins to build Docker Images<a class="headerlink" href="#working-with-jenkins-to-build-docker-images" title="Permalink to this headline">¶</a></h2>
<p>Now that we are all set with Jenkins, we will learn how to configure Jenkins to build Docker Images based on a Dockerfile. Below are the steps of how you can use Docker within a CI/CD pipeline, using Images as a build artifact that can be promoted to different environments and finally production.</p>
<div class="section" id="step-1-launch-jenkins">
<h3>Step #1 : Launch Jenkins<a class="headerlink" href="#step-1-launch-jenkins" title="Permalink to this headline">¶</a></h3>
<p>We have Jenkins running on Docker container, if you run the docker ps command it would show you the status of the container.
Let’s launch the Jenkins Dashboard, for this navigate to your webrowser and login with the admin user id that you have created.</p>
<p>localhost:[YOUR PORT]</p>
</div>
<div class="section" id="step-2-configure-the-plugins-and-start-building-docker-images">
<h3>Step #2 : Configure the plugins and start building Docker Images<a class="headerlink" href="#step-2-configure-the-plugins-and-start-building-docker-images" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>Our 1st step is to configure Docker plugin. Whenever a Jenkins build requires Docker, it will create a “Cloud Agent” via the plugin. The agent will be a Docker Container configured to talk to our Docker Daemon.The Jenkins build job will use this container to execute the build and create the image before being stopped. The Docker Image will be stored on the configured Docker Daemon. The Image can then be pushed to a Docker Registry ready for deployment.</dt>
<dd><ul class="first last simple">
<li>Once you are inside the Jenkins Dashboard, select Manage Jenkins on the left.</li>
<li>On the Configuration page, select Manage Plugins.</li>
<li>Manage Plugins page will give you a tabbed interface. Click Available to view all the Jenkins plugins that can be installed.</li>
<li>Using the search box, search for Docker plugin. There are multiple Docker plugins, select Docker plugin using the checkbox.</li>
<li>While on this page, install the Git plugin for obtaining the source code from a Git repository.</li>
<li>Click Install without Restart at the bottom.</li>
<li>The plugins will now be downloaded and installed. Once complete, click the link Go back to the top page.</li>
</ul>
</dd>
</dl>
<p>&lt;.. image:: path</p>
<p>Once the Docker &amp; GIT plugins have been installed, now we can go ahead and configure how they launch the Docker Containers.</p>
</div>
<div class="section" id="step-3-configure-docker-agent">
<h3>Step #3 : Configure Docker agent<a class="headerlink" href="#step-3-configure-docker-agent" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>Navigate back to the Jenkins Dashboard</dt>
<dd><ul class="first last simple">
<li>Select Manage Jenkins.</li>
<li>Select Configure System to access the main Jenkins settings.</li>
<li>At the bottom, there is a dropdown called Add a new cloud. Select Docker from the list.</li>
<li>&lt;.. image:: path</li>
</ul>
</dd>
<dt>You can now configure the container options. Set the name of the agent to docker-agent.</dt>
<dd><ul class="first last simple">
<li>The “Docker URL” is where Jenkins launches the agent container. In our case, we’ll use the same daemon as running Jenkins, but in real world scenario it should be separate instance so that it can scale.</li>
<li>Use Test Connection to verify Jenkins can talk to the Docker Daemon. You should see the Docker version number returned.</li>
</ul>
</dd>
<dt>Now the plugin can communicate with Docker,next step would be to configure how to launch the Docker Image for the agent.</dt>
<dd><ul class="first last simple">
<li>Using the Images dropdown, select Add Docker Template dropdown.</li>
<li>For the Docker Image, use sample one which has Docker client benhall/dind-jenkins-agent. This image is configured with a Docker client and available at <a class="reference external" href="https://hub.docker.com/r/benhall/dind-jenkins-agent/">https://hub.docker.com/r/benhall/dind-jenkins-agent/</a></li>
<li>To enable builds to specify Docker as a build agent, set a label of docker-agent.</li>
<li>Jenkins uses SSH to communicate with agents. Add a new set of “Credentials”. The username is jenkins and the password is jenkins.</li>
<li>Finally, expand the Container Settings section by clicking the button. In the “Volumes” text box enter /var/run/docker.sock:/var/run/docker.sock</li>
<li>Click Save.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="step-4-test-the-setup">
<h3>Step #4 : Test the setup<a class="headerlink" href="#step-4-test-the-setup" title="Permalink to this headline">¶</a></h3>
<p>On the Jenkins dashboard, select Create new jobs of type Freestyle project &amp; create new job eg. Jenkins Docker Demo.</p>
<ul class="simple">
<li>The build will depend on having access to Docker. Using the “Restrict where this project can be run” we can define the label we set of our configured Docker agent. The set “Label Expression” to docker-agent. You should have a configuration of “Label is serviced by no nodes and 1 cloud”.</li>
<li>Select the Repository type as Git and set the Repository.</li>
<li>Use the repository that you created in Lab 1</li>
<li>We can now add a new Build Step using the dropdown. Select Execute Shell.</li>
</ul>
<p>Build Step: In the shell screen that you are shown, enter following commands -</p>
<p>ls</p>
<p>docker info</p>
<p>docker build -t jenkins-demo:${BUILD_NUMBER} .</p>
<p>docker tag jenkins-demo:${BUILD_NUMBER} jenkins-demo:latest</p>
<p>docker images</p>
<p>The first command lists all the files in the directory which will be built. When calling docker build we use the Jenkins build number as the image tag. This allows us to version our Docker Images. We also tag the build with latest.</p>
<p>Docker File:</p>
<p>FROM scratch
EXPOSE 80
COPY http-server /
CMD [“/http-server”]</p>
<p>On the left-hand side, select Build Now.
You should see a build getting scheduled with a message “(pending — Waiting for next available executor)”.</p>
<p>Jenkins is launching the container and connecting to it via SSH. Sometimes this can take a moment or two.
You can see the progress using command -</p>
<p>docker logs –tail=10 jenkins</p>
<p>Once the build has completed you should see the Image and Tags using the Docker CLI</p>
<p>docker images</p>
</div>
</div>
<div class="section" id="working-with-jenkins-pipelines">
<h2>Working with Jenkins Pipelines<a class="headerlink" href="#working-with-jenkins-pipelines" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>We have already created a Git repo in our Lab #1. Since Jenkins needs to push tags to the origin repo, it will need a basic Git configuration. Let’s do that now.</dt>
<dd><ul class="first last simple">
<li>Go to Jenkins &gt; Manage Jenkins &gt; Configure System &gt; Git plugin.</li>
<li>Enter an username of your choice and also your email</li>
</ul>
</dd>
</dl>
<div class="section" id="create-a-new-job">
<h3>Create a new job<a class="headerlink" href="#create-a-new-job" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>We will start by creating a new freestyle project with a name of your choosing (for example, “Ntnx-staging”)</li>
<li>Under General, check “This project is parameterized”.</li>
<li>Add two parameters, as shown below.</li>
<li>&lt;.. image:: path&gt;</li>
<li>The “Default Value” of COMMIT_HASH is set to “refs/heads/master” for convenience since we just want to make sure the job has a valid commit to work with.</li>
<li>In the future, you may wish to set this to something more relevant like “refs/heads/sprint1”, or clear this field entirely.</li>
<li>Under Source Code Management, choose ‘Git’.
- Add the URL of the repository and the credentials. (Jenkins will attempt to authenticate against this URL as a test, so it should give you an error promptly if the authentication fails.)
- Use the commit hash given when the job was started by typing ${COMMIT_HASH} in the Branch Specifier field.</li>
<li>Under Post-build Actions, add an action with the type “Git Publisher”.</li>
<li>Choose “Add Tag” and set the options as shown below.</li>
<li>&lt;.. image:: path&gt;</li>
<li>We check both boxes, because we want Jenkins to do whatever it needs to do in the tagging process (create or update tags as needed).</li>
<li>${TAG} is the second parameter given when the job was started.</li>
</ul>
<p>When you run the job, you’ll be prompted to enter a commit hash and tag name. Here, you can see that I’ve kicked off two builds: The first build checked out and tagged the latest commit on master.</p>
<p>Make a couple of builds. Check if the first build, the HEAD of the master branch, succeeded.
- It should be tagged with “0.0.1” and pushed to the origin repo.
- The second build, should get tagged as well</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../_sources/devJenkins/devJenkins.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2019 Nutanix.<br/>
    </p>
  </div>
</footer>
  </body>
</html>